<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swap Admin Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1em;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .card-title {
        color: #2c3e50;
        font-size: 1.3em;
        margin-bottom: 20px;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid #ecf0f1;
      }

      .stat:last-child {
        border-bottom: none;
      }

      .stat-label {
        color: #7f8c8d;
        font-weight: 500;
      }

      .stat-value {
        color: #2c3e50;
        font-size: 1.5em;
        font-weight: bold;
      }

      .stat-value.positive {
        color: #27ae60;
      }

      .stat-value.warning {
        color: #f39c12;
      }

      .stat-value.danger {
        color: #e74c3c;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        margin-right: 5px;
      }

      .status-badge.healthy {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.warning {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.critical {
        background: #f8d7da;
        color: #721c24;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .admin-link {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        margin-top: 15px;
        transition: background 0.3s;
      }

      .admin-link:hover {
        background: #2980b9;
      }

      .chart-container {
        margin-top: 20px;
        min-height: 250px;
        background: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: white;
        margin-top: 40px;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }

      .refresh-btn {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s;
      }

      .refresh-btn:hover {
        background: #229954;
      }

      .last-updated {
        color: #95a5a6;
        font-size: 0.9em;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìä Swap Admin Dashboard</h1>
        <p>Real-time platform monitoring and administration</p>
        <button class="refresh-btn" onclick="loadDashboard()">
          üîÑ Refresh Data
        </button>
        <div class="last-updated" id="last-updated"></div>
      </div>

      <div id="error-container"></div>

      <div class="grid" id="dashboard-grid">
        <div class="card">
          <div class="card-title">üìà System Status</div>
          <div class="loading">Loading system data...</div>
        </div>
        <div class="card">
          <div class="card-title">‚öñÔ∏è Disputes</div>
          <div class="loading">Loading dispute data...</div>
        </div>
        <div class="card">
          <div class="card-title">üë• User Moderation</div>
          <div class="loading">Loading moderation data...</div>
        </div>
        <div class="card">
          <div class="card-title">üîß Service Health</div>
          <div class="loading">Loading service data...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìä Service Health Details</div>
        <div id="services-container">
          <div class="loading">Loading services...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚ö° Recent Disputes</div>
        <div id="disputes-container">
          <div class="loading">Loading disputes...</div>
        </div>
      </div>

      <div class="footer">
        <p>
          Swap Platform Administration |
          <a href="/admin/" style="color: white; text-decoration: underline"
            >Go to Django Admin</a
          >
        </p>
        <p style="margin-top: 10px; font-size: 0.9em">
          Dashboard updated at: <span id="current-time"></span>
        </p>
      </div>
    </div>

    <script>
      // Update current time
      function updateTime() {
        const now = new Date();
        document.getElementById("current-time").textContent =
          now.toLocaleTimeString();
      }

      // Format currency
      function formatCurrency(value) {
        return "$" + parseFloat(value).toFixed(2);
      }

      // Load dashboard data
      async function loadDashboard() {
        try {
          const [overview, services, disputes] = await Promise.all([
            fetch("/api/dashboard-overview/").then((r) => r.json()),
            fetch("/api/service-health/").then((r) => r.json()),
            fetch("/api/recent-disputes/?limit=10").then((r) => r.json()),
          ]);

          document.getElementById("error-container").innerHTML = "";
          updateDashboardCards(overview);
          updateServices(services);
          updateDisputes(disputes);
          document.getElementById(
            "last-updated"
          ).textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          showError("Failed to load dashboard data: " + error.message);
          console.error(error);
        }
      }

      // Update dashboard cards
      function updateDashboardCards(data) {
        if (data.status !== "success") {
          showError("Dashboard data error: " + data.message);
          return;
        }

        const grid = document.getElementById("dashboard-grid");
        const monitor = data.system_monitor;
        const disputes = data.disputes;
        const moderation = data.moderation;
        const services = data.services;

        grid.innerHTML = `
                <div class="card">
                    <div class="card-title">üìà System Status</div>
                    <div class="stat">
                        <span class="stat-label">Status</span>
                        <span class="status-badge ${monitor.status.toLowerCase()}">${monitor.status.toUpperCase()}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Total Users</span>
                        <span class="stat-value">${monitor.total_users}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Active Listings</span>
                        <span class="stat-value">${
                          monitor.active_listings
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Pending Offers</span>
                        <span class="stat-value">${
                          monitor.pending_offers
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Total Transactions</span>
                        <span class="stat-value">${
                          monitor.total_transactions
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Escrow Balance</span>
                        <span class="stat-value positive">${formatCurrency(
                          monitor.escrow_balance
                        )}</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">‚öñÔ∏è Disputes</div>
                    <div class="stat">
                        <span class="stat-label">Total Disputes</span>
                        <span class="stat-value">${disputes.total}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Open</span>
                        <span class="stat-value warning">${disputes.open}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">In Review</span>
                        <span class="stat-value warning">${
                          disputes.in_review
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Resolved</span>
                        <span class="stat-value positive">${
                          disputes.resolved
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Closed</span>
                        <span class="stat-value positive">${
                          disputes.closed
                        }</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üë• User Moderation</div>
                    <div class="stat">
                        <span class="stat-label">Total Actions</span>
                        <span class="stat-value">${
                          moderation.total_actions
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Warnings</span>
                        <span class="stat-value">${moderation.warnings}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Suspensions</span>
                        <span class="stat-value warning">${
                          moderation.suspensions
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Bans</span>
                        <span class="stat-value danger">${
                          moderation.bans
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Active</span>
                        <span class="stat-value danger">${
                          moderation.active
                        }</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üîß Service Health</div>
                    <div class="stat">
                        <span class="stat-label">Total Services</span>
                        <span class="stat-value">${
                          services.total_services
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Healthy</span>
                        <span class="stat-value positive">${
                          services.healthy
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Warning</span>
                        <span class="stat-value warning">${
                          services.warning
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Critical</span>
                        <span class="stat-value danger">${
                          services.critical
                        }</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Avg Response</span>
                        <span class="stat-value">${
                          services.avg_response_time
                        }ms</span>
                    </div>
                </div>
            `;
      }

      // Update services list
      function updateServices(data) {
        if (data.status !== "success" || !data.services) {
          document.getElementById("services-container").innerHTML =
            '<div class="error">Failed to load services</div>';
          return;
        }

        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html +=
          '<tr style="background: #f8f9fa; border-bottom: 2px solid #3498db;"><th style="padding: 10px; text-align: left;">Service</th><th style="padding: 10px; text-align: left;">Status</th><th style="padding: 10px; text-align: left;">Response Time</th><th style="padding: 10px; text-align: left;">Failures</th><th style="padding: 10px; text-align: left;">Last Check</th></tr>';

        data.services.forEach((service) => {
          const statusClass = service.status.toLowerCase();
          html += `<tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 10px;">${service.service_name}</td>
                    <td style="padding: 10px;"><span class="status-badge ${statusClass}">${
            service.status
          }</span></td>
                    <td style="padding: 10px;">${
                      service.response_time_ms
                    }ms</td>
                    <td style="padding: 10px;">${
                      service.consecutive_failures
                    }</td>
                    <td style="padding: 10px;">${new Date(
                      service.last_check
                    ).toLocaleTimeString()}</td>
                </tr>`;
        });

        html += "</table>";
        document.getElementById("services-container").innerHTML = html;
      }

      // Update disputes list
      function updateDisputes(data) {
        if (data.status !== "success" || !data.disputes) {
          document.getElementById("disputes-container").innerHTML =
            '<div class="error">Failed to load disputes</div>';
          return;
        }

        if (data.disputes.length === 0) {
          document.getElementById("disputes-container").innerHTML =
            '<p style="text-align: center; padding: 20px;">No disputes found</p>';
          return;
        }

        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html +=
          '<tr style="background: #f8f9fa; border-bottom: 2px solid #3498db;"><th style="padding: 10px; text-align: left;">ID</th><th style="padding: 10px; text-align: left;">Reason</th><th style="padding: 10px; text-align: left;">Status</th><th style="padding: 10px; text-align: left;">Priority</th><th style="padding: 10px; text-align: left;">Amount</th><th style="padding: 10px; text-align: left;">Created</th></tr>';

        data.disputes.forEach((dispute) => {
          const statusClass = dispute.status.toLowerCase();
          const priorityClass = dispute.priority.toLowerCase();
          html += `<tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 10px;">${dispute.dispute_id}</td>
                    <td style="padding: 10px;">${dispute.reason}</td>
                    <td style="padding: 10px;"><span class="status-badge ${statusClass}">${
            dispute.status
          }</span></td>
                    <td style="padding: 10px;"><strong>${
                      dispute.priority
                    }</strong></td>
                    <td style="padding: 10px;">${formatCurrency(
                      dispute.amount
                    )}</td>
                    <td style="padding: 10px;">${new Date(
                      dispute.created_at
                    ).toLocaleDateString()}</td>
                </tr>`;
        });

        html += "</table>";
        document.getElementById("disputes-container").innerHTML = html;
      }

      // Show error message
      function showError(message) {
        const container = document.getElementById("error-container");
        container.innerHTML = `<div class="error">${message}</div>`;
      }

      // Initialize dashboard
      window.addEventListener("load", () => {
        updateTime();
        setInterval(updateTime, 1000);
        loadDashboard();
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
      });
    </script>
  </body>
</html>
