user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 50M;

upstream auth_backend {
    server auth:8000;
}

upstream user_backend {
    server user:8000;
}

upstream listing_backend {
    server listing:8000;
}

upstream offer_backend {
    server offer:8003;
}

upstream payment_backend {
    server payment:8004;
}

upstream chat_backend {
    server chat:8006;
}

upstream notification_backend {
    server notification:8007;
}

upstream admin_backend {
    server admin:8005;
}

upstream frontend_backend {
    server frontend:3000;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=payment_limit:10m rate=5r/s;

# Cache zones
proxy_cache_path /var/cache/nginx/general levels=1:2 keys_zone=general_cache:10m max_size=1g inactive=60m;
proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m max_size=500m inactive=30m;

server {
    listen 80;
    server_name localhost 127.0.0.1;
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # CORS headers for API
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Max-Age "86400" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # ==================== HEALTH CHECKS ====================
    location /health {
        access_log off;
        return 200 "Nginx proxy is healthy\n";
        add_header Content-Type text/plain;
    }

    # ==================== DOCUMENTATION ====================
    location /docs {
        return 301 /api/auth/docs;
    }

    # ==================== AUTH SERVICE ====================
    location /api/auth/ {
        limit_req zone=auth_limit burst=20 nodelay;
        
        proxy_pass http://auth_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Auth endpoints should not be cached
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # ==================== USER SERVICE ====================
    location /api/users/ {
        limit_req zone=general_limit burst=50 nodelay;
        
        proxy_pass http://user_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache general_cache;
        proxy_cache_valid 200 10m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    }

    # ==================== LISTING SERVICE ====================
    location /api/listings/ {
        limit_req zone=general_limit burst=50 nodelay;
        
        proxy_pass http://listing_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache general_cache;
        proxy_cache_valid 200 15m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    }

    # ==================== OFFER SERVICE ====================
    location /api/offers/ {
        limit_req zone=general_limit burst=50 nodelay;
        
        proxy_pass http://offer_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache general_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    }

    # ==================== PAYMENT SERVICE ====================
    location /api/payments/ {
        limit_req zone=payment_limit burst=10 nodelay;
        
        proxy_pass http://payment_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Payment endpoints should not be cached
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # ==================== CHAT SERVICE ====================
    location /api/chat/ {
        limit_req zone=general_limit burst=50 nodelay;
        
        proxy_pass http://chat_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Chat is real-time, minimize caching
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # WebSocket support for chat
    location /ws/chat/ {
        proxy_pass http://chat_backend/ws/chat/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket specific settings
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # ==================== NOTIFICATION SERVICE ====================
    location /api/notifications/ {
        limit_req zone=general_limit burst=50 nodelay;
        
        proxy_pass http://notification_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Notifications can be cached briefly
        proxy_cache general_cache;
        proxy_cache_valid 200 2m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    }

    # ==================== ADMIN SERVICE ====================
    location /admin/ {
        limit_req zone=general_limit burst=30 nodelay;
        
        proxy_pass http://admin_backend/admin/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Admin interface should not be cached
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    location /dashboard/ {
        limit_req zone=general_limit burst=30 nodelay;
        
        proxy_pass http://admin_backend/dashboard/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/dashboard-overview/ {
        proxy_pass http://admin_backend/api/dashboard-overview/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache general_cache;
        proxy_cache_valid 200 1m;
    }

    location /api/service-health/ {
        proxy_pass http://admin_backend/api/service-health/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache general_cache;
        proxy_cache_valid 200 30s;
    }

    # ==================== FRONTEND ====================
    location / {
        proxy_pass http://frontend_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Frontend static assets caching
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Don't cache HTML files to ensure latest version
        location ~ \.(html|json)$ {
            proxy_pass http://frontend_backend;
            proxy_cache_bypass 1;
            proxy_no_cache 1;
        }

        # Cache static assets (JS, CSS, Images) for 1 month
        location ~ \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://frontend_backend;
            proxy_cache api_cache;
            proxy_cache_valid 200 30d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            add_header X-Cache-Status $upstream_cache_status;
        }
    }

    # ==================== STATIC FILES & FALLBACK ====================
    location / {
        return 404 '{"error": "Not Found. Check /health for status or see documentation at /docs"}';
        add_header Content-Type application/json;
    }

    # ==================== ERROR PAGES ====================
    error_page 502 503 504 /50x.json;
    location = /50x.json {
        internal;
        return 200 '{"error": "Service temporarily unavailable", "status": 503}';
        add_header Content-Type application/json;
    }
}
}
